<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsext Adventure: Halloween Haunt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
            border: 2px solid #ff6b35;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #ff6b35;
            text-shadow: 0 0 10px #ff6b35;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #8b5cf6;
            margin-bottom: 20px;
        }

        .warning {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid #ff6b35;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-area {
            min-height: 400px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .scene-title {
            font-size: 1.5em;
            color: #ff6b35;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 10px;
        }

        .scene-description {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .choices {
            margin-top: 20px;
        }

        .choice {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid #8b5cf6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            color: #fff;
            text-decoration: none;
            display: block;
            user-select: none;
            -webkit-user-select: none;
            /* 改善觸控回饋 */
            -webkit-tap-highlight-color: rgba(139, 92, 246, 0.3);
            touch-action: manipulation;
        }

        .choice:hover {
            background: rgba(139, 92, 246, 0.4);
            transform: translateX(5px);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }

        .ending {
            text-align: center;
            padding: 20px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 2px solid #ff6b35;
        }

        .ending-title {
            font-size: 1.8em;
            color: #ff6b35;
            margin-bottom: 15px;
        }

        .ending-outcome {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .score {
            font-size: 1.1em;
            color: #8b5cf6;
            margin-bottom: 15px;
        }

        .restart-btn {
            background: linear-gradient(45deg, #ff6b35, #8b5cf6);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        .start-screen {
            text-align: center;
        }

        .player-input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 1.1em;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            text-align: center;
        }

        .start-btn {
            background: linear-gradient(45deg, #8b5cf6, #ff6b35);
            border: none;
            border-radius: 25px;
            padding: 15px 40px;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.5);
        }

        .start-btn:focus,
        .restart-btn:focus,
        .share-btn:focus,
        .close-btn:focus {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
        }

        /* 鍵盤導航支援 */
        .choice:focus {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
            background: rgba(139, 92, 246, 0.4);
        }

        .achievements-toggle:focus {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
        }

        /* 載入狀態改善 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #8b5cf6;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 效能優化 */
        * {
            box-sizing: border-box;
        }

        .container,
        .game-area,
        .achievement-popup {
            will-change: transform;
            backface-visibility: hidden;
        }

        /* 防止文字選取 */
        .achievement-popup,
        .stats-panel,
        .achievements-panel {
            user-select: none;
            -webkit-user-select: none;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid #ff6b35;
            border-radius: 15px;
            padding: 30px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 107, 53, 0.5);
            animation: achievementPop 0.5s ease-out;
        }

        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .achievement-icon {
            font-size: 4em;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .achievement-title {
            font-size: 1.8em;
            color: #ff6b35;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .achievement-description {
            font-size: 1.1em;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .achievement-rarity {
            font-size: 1em;
            padding: 5px 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .rarity-common { background: #9CA3AF; color: #000; }
        .rarity-rare { background: #3B82F6; color: #fff; }
        .rarity-epic { background: #8B5CF6; color: #fff; }
        .rarity-legendary { background: #F59E0B; color: #000; }

        .achievement-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            background: linear-gradient(45deg, #ff6b35, #8b5cf6);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .share-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
        }

        .close-btn {
            background: #666;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .close-btn:hover {
            background: #888;
            transform: scale(1.05);
        }

        .achievements-panel {
            position: fixed;
            top: 20px;
            right: -320px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #8b5cf6;
            border-radius: 10px 0 0 10px;
            padding: 15px;
            z-index: 100;
            max-width: 300px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
        }

        .achievements-panel.open {
            right: 0;
        }

        .achievements-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #8b5cf6, #ff6b35);
            border: 2px solid #8b5cf6;
            border-right: none;
            border-radius: 10px 0 0 10px;
            padding: 15px 10px;
            cursor: pointer;
            z-index: 101;
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            color: white;
            font-size: 1em;
        }

        .achievements-toggle:hover {
            padding-left: 15px;
            box-shadow: -5px 0 15px rgba(139, 92, 246, 0.5);
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b5cf6;
        }

        .achievements-title {
            font-size: 1.2em;
            color: #8b5cf6;
            font-weight: bold;
        }

        .achievements-close {
            background: transparent;
            border: none;
            color: #ff6b35;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .achievements-close:hover {
            background: rgba(255, 107, 53, 0.2);
            transform: rotate(90deg);
        }

        .achievement-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .achievement-item:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: translateX(5px);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .achievement-item.unlocked {
            background: rgba(255, 107, 53, 0.2);
            border-color: rgba(255, 107, 53, 0.5);
        }

        .achievement-item.unlocked:hover {
            background: rgba(255, 107, 53, 0.3);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }

        .achievement-item-icon {
            font-size: 2em;
            margin-right: 12px;
            min-width: 40px;
            text-align: center;
        }

        .achievement-item-text {
            flex: 1;
        }

        .achievement-item-name {
            font-size: 0.95em;
            color: #fff;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .achievement-item-desc {
            font-size: 0.8em;
            color: #ccc;
            line-height: 1.3;
        }

        .stats-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #ff6b35;
            border-radius: 10px;
            padding: 15px;
            z-index: 100;
            min-width: 200px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
        }

        .stats-title {
            font-size: 1.2em;
            color: #ff6b35;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #e0e0e0;
            padding: 5px;
            border-radius: 5px;
            background: rgba(255, 107, 53, 0.1);
        }

        .stat-item span:first-child {
            font-weight: 600;
        }

        .stat-item span:last-child {
            color: #ff6b35;
            font-weight: bold;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .loading {
            text-align: center;
            color: #8b5cf6;
            font-size: 1.2em;
        }

        /* RWD - 大型螢幕 */
        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }

            .title {
                font-size: 3em;
            }

            .achievements-panel {
                width: 350px;
                right: -370px;
            }

            .stats-panel {
                min-width: 220px;
            }
        }

        /* RWD - 平板和小螢幕 */
        @media (max-width: 1024px) {
            .stats-panel {
                top: 10px;
                left: 10px;
                min-width: 150px;
                font-size: 0.9em;
            }

            .achievements-panel {
                width: 250px;
                right: -270px;
            }

            .achievements-toggle {
                font-size: 0.9em;
                padding: 12px 8px;
            }

            /* 改善按鈕觸控區域 */
            .choice {
                padding: 18px;
                margin-bottom: 12px;
                font-size: 1em;
            }

            .start-btn, .restart-btn {
                padding: 15px 35px;
                font-size: 1.1em;
                min-height: 50px;
            }
        }

        /* RWD - 手機橫向 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 5px;
                width: calc(100% - 10px);
            }
            
            .title {
                font-size: 1.8em;
                line-height: 1.2;
                margin-bottom: 15px;
            }

            .subtitle {
                font-size: 1em;
                line-height: 1.4;
                margin-bottom: 15px;
            }

            .warning {
                font-size: 0.9em;
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .scene-title {
                font-size: 1.2em;
                line-height: 1.3;
                padding-bottom: 8px;
            }

            .scene-description {
                font-size: 1em;
                line-height: 1.5;
                margin-bottom: 15px;
            }

            .choice {
                font-size: 0.95em;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 10px;
                /* 改善觸控體驗 */
                min-height: 50px;
                display: flex;
                align-items: center;
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(139, 92, 246, 0.3);
            }

            .choice:active {
                transform: translateX(3px) scale(0.98);
                background: rgba(139, 92, 246, 0.6);
            }

            .stats-panel {
                top: 10px;
                left: 10px;
                min-width: 120px;
                font-size: 0.85em;
                padding: 10px;
                border-radius: 8px;
            }

            .stats-title {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .stat-item {
                font-size: 0.85em;
                margin-bottom: 5px;
                padding: 3px 5px;
            }

            .achievements-panel {
                width: 220px;
                right: -240px;
                max-height: 70vh;
                border-radius: 10px 0 0 10px;
            }

            .achievements-toggle {
                font-size: 0.85em;
                padding: 10px 6px;
                border-radius: 8px 0 0 8px;
            }

            .achievement-popup {
                width: 90%;
                max-width: 350px;
                padding: 20px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .achievement-icon {
                font-size: 3em;
                margin-bottom: 10px;
            }

            .achievement-title {
                font-size: 1.5em;
                line-height: 1.2;
                margin-bottom: 8px;
            }

            .achievement-description {
                font-size: 0.95em;
                line-height: 1.4;
            }

            .share-btn, .close-btn {
                font-size: 0.9em;
                padding: 10px 18px;
                border-radius: 20px;
                margin: 5px;
                min-height: 40px;
                /* 改善觸控體驗 */
                -webkit-tap-highlight-color: transparent;
            }

            .share-btn:active, .close-btn:active {
                transform: scale(0.95);
            }

            .player-input {
                font-size: 1em;
                padding: 12px;
                border-radius: 8px;
                width: 90%;
            }

            .start-btn, .restart-btn {
                font-size: 1em;
                padding: 12px 25px;
                border-radius: 20px;
                min-height: 45px;
                margin: 10px 5px;
            }
        }

        /* RWD - 手機直向 */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 12px;
                margin: 0;
                width: 100%;
                max-width: none;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(255, 107, 53, 0.2);
            }

            .header {
                margin-bottom: 20px;
            }

            .title {
                font-size: 1.4em;
                line-height: 1.1;
                margin-bottom: 8px;
                text-shadow: 0 0 8px #ff6b35;
            }

            .subtitle {
                font-size: 0.9em;
                line-height: 1.3;
                margin-bottom: 12px;
            }

            .warning {
                font-size: 0.85em;
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 15px;
                line-height: 1.3;
            }

            .game-area {
                padding: 15px;
                min-height: 300px;
                border-radius: 8px;
                margin-bottom: 15px;
            }

            .scene-title {
                font-size: 1.1em;
                line-height: 1.2;
                margin-bottom: 10px;
                padding-bottom: 8px;
            }

            .scene-description {
                font-size: 0.9em;
                line-height: 1.4;
                margin-bottom: 15px;
            }

            .choices {
                margin-top: 15px;
            }

            .choice {
                font-size: 0.85em;
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                line-height: 1.3;
                min-height: 45px;
                display: flex;
                align-items: center;
                text-align: left;
                /* 優化小螢幕觸控 */
                -webkit-tap-highlight-color: rgba(139, 92, 246, 0.2);
                touch-action: manipulation;
            }

            .choice:hover {
                transform: translateX(2px);
            }

            .choice:active {
                transform: translateX(1px) scale(0.98);
            }

            .stats-panel {
                position: relative;
                top: 0;
                left: 0;
                width: 100%;
                margin-bottom: 10px;
                box-sizing: border-box;
                border-radius: 8px;
                padding: 10px;
            }

            .stats-title {
                font-size: 0.9em;
                margin-bottom: 6px;
            }

            .stat-item {
                font-size: 0.8em;
                margin-bottom: 4px;
                padding: 2px 4px;
            }

            .achievements-panel {
                width: 90%;
                right: -95%;
                top: 60px;
                max-height: 65vh;
                border-radius: 8px 0 0 8px;
            }

            .achievements-toggle {
                top: 60%;
                font-size: 0.75em;
                padding: 8px 4px;
                border-radius: 6px 0 0 6px;
                writing-mode: vertical-rl;
            }

            .achievement-popup {
                width: 96%;
                padding: 15px;
                max-height: 85vh;
                border-radius: 12px;
                margin: 0 2%;
            }

            .achievement-icon {
                font-size: 2.5em;
                margin-bottom: 8px;
            }

            .achievement-title {
                font-size: 1.2em;
                line-height: 1.1;
                margin-bottom: 6px;
            }

            .achievement-description {
                font-size: 0.85em;
                line-height: 1.3;
                margin-bottom: 10px;
            }

            .achievement-rarity {
                font-size: 0.8em;
                padding: 4px 12px;
                margin-bottom: 15px;
            }

            .achievement-actions {
                flex-direction: column;
                gap: 8px;
            }

            .achievement-actions button {
                width: 100%;
                min-height: 42px;
                font-size: 0.85em;
                padding: 10px 15px;
                border-radius: 20px;
            }

            .player-input {
                width: 95%;
                max-width: 280px;
                font-size: 0.95em;
                padding: 10px;
                border-radius: 8px;
                margin: 15px auto;
            }

            .start-btn, .restart-btn {
                font-size: 0.95em;
                padding: 12px 25px;
                border-radius: 20px;
                min-height: 45px;
                margin: 8px 4px;
            }

            .ending {
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
            }

            .ending-title {
                font-size: 1.4em;
                line-height: 1.2;
                margin-bottom: 10px;
            }

            .ending-outcome {
                font-size: 0.95em;
                line-height: 1.4;
                margin-bottom: 15px;
            }

            .score {
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            .footer {
                margin-top: 20px;
                font-size: 0.8em;
                line-height: 1.3;
            }

            .footer a {
                color: #8b5cf6;
                text-decoration: none;
            }

            .footer a:hover {
                text-decoration: underline;
            }
        }

        /* RWD - 超小螢幕 (320px - 360px) */
        @media (max-width: 360px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 8px;
                border-radius: 8px;
            }

            .title {
                font-size: 1.2em;
                line-height: 1.1;
                margin-bottom: 6px;
            }

            .subtitle {
                font-size: 0.85em;
                margin-bottom: 10px;
            }

            .warning {
                font-size: 0.8em;
                padding: 8px;
                margin-bottom: 12px;
            }

            .game-area {
                padding: 12px;
                min-height: 250px;
            }

            .scene-title {
                font-size: 1em;
                line-height: 1.1;
                margin-bottom: 8px;
                padding-bottom: 6px;
            }

            .scene-description {
                font-size: 0.85em;
                line-height: 1.4;
                margin-bottom: 12px;
            }

            .choice {
                font-size: 0.8em;
                padding: 10px;
                margin-bottom: 6px;
                min-height: 40px;
                border-radius: 6px;
            }

            .stats-panel {
                font-size: 0.75em;
                padding: 8px;
            }

            .stats-title {
                font-size: 0.85em;
                margin-bottom: 5px;
            }

            .stat-item {
                font-size: 0.75em;
                margin-bottom: 3px;
                padding: 1px 3px;
            }

            .achievement-popup {
                width: 98%;
                padding: 12px;
                margin: 0 1%;
            }

            .achievement-icon {
                font-size: 2.2em;
            }

            .achievement-title {
                font-size: 1.1em;
            }

            .achievement-description {
                font-size: 0.8em;
            }

            .achievement-actions button {
                font-size: 0.8em;
                padding: 8px 12px;
                min-height: 38px;
            }

            .player-input {
                font-size: 0.9em;
                padding: 8px;
                width: 98%;
                max-width: 250px;
            }

            .start-btn, .restart-btn {
                font-size: 0.9em;
                padding: 10px 20px;
                min-height: 42px;
            }

            .ending-title {
                font-size: 1.2em;
            }

            .ending-outcome {
                font-size: 0.9em;
            }

            .footer {
                font-size: 0.75em;
                margin-top: 15px;
            }
        }

        /* 輔助功能改善 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .choice:hover,
            .choice:active {
                transform: none;
            }
        }

        /* 高對比度模式支援 */
        @media (prefers-contrast: high) {
            .container {
                border: 3px solid #fff;
                background: rgba(0, 0, 0, 0.95);
            }
            
            .choice {
                border: 2px solid #fff;
                background: rgba(139, 92, 246, 0.8);
            }
            
            .achievement-popup {
                border: 3px solid #fff;
                background: rgba(0, 0, 0, 0.95);
            }
        }

        /* 暗色主題偏好 */
        @media (prefers-color-scheme: dark) {
            /* 本遊戲預設就是暗色主題，所以不需要額外調整 */
        }

        /* 捲軸樣式 */
        .achievements-panel::-webkit-scrollbar {
            width: 8px;
        }

        .achievements-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .achievements-panel::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 4px;
        }

        .achievements-panel::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🎃 Tsext Adventure: Halloween Haunt 🎃</h1>
            <p class="subtitle">萬聖節瑟瑟冒險遊戲</p>
        </div>

        <div class="warning">
            ⚠️ <strong>NSFW 警告</strong>：本遊戲包含成人暗示和幽默，適合 18 歲以上玩家
        </div>

        <!-- 統計面板 -->
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stats-title">📊 遊戲統計</div>
            <div class="stat-item">
                <span>總分數:</span>
                <span id="totalScore">0</span>
            </div>
            <div class="stat-item">
                <span>遊玩次數:</span>
                <span id="playCount">0</span>
            </div>
            <div class="stat-item">
                <span>解鎖成就:</span>
                <span id="achievementCount">0</span>
            </div>
            <div class="stat-item">
                <span>探索場景:</span>
                <span id="sceneCount">0</span>
            </div>
        </div>

        <!-- 成就切換按鈕 -->
        <div class="achievements-toggle" id="achievementsToggle" onclick="toggleAchievementsPanel()" style="display: none;">
            🏆 成就列表
        </div>

        <!-- 成就面板 -->
        <div class="achievements-panel" id="achievementsPanel">
            <div class="achievements-header">
                <div class="achievements-title">🏆 成就列表</div>
                <button class="achievements-close" onclick="toggleAchievementsPanel()">✕</button>
            </div>
            <div id="achievementsList"></div>
        </div>

        <div class="game-area" id="gameArea">
            <div class="start-screen" id="startScreen">
                <h2>👻 歡迎來到萬聖節靈異約會趴！</h2>
                <p>準備好參加最刺激的萬聖節冒險了嗎？</p>
                <input type="text" class="player-input" id="playerName" placeholder="請輸入你的名字" maxlength="20">
                <br>
                <button class="start-btn" onclick="startGame()">開始冒險 🎃</button>
            </div>
        </div>

        <div class="footer">
            <p>🎃 Happy Halloween! 🎃</p>
            <p>開源專案 | MIT License | <a href="https://github.com/dennislee928/tsext-adventure" style="color: #8b5cf6;">GitHub</a></p>
        </div>
    </div>

    <script>
        // 遊戲狀態
        let gameState = {
            currentScene: 'start',
            playerName: '',
            score: 0,
            visitedScenes: new Set(),
            unlockedAchievements: new Set(),
            unlockedBadges: new Set(),
            playCount: 0,
            totalScore: 0,
            gameStartTime: null,
            allEndingsUnlocked: new Set(),
            allScenesVisited: new Set(),
            punsTriggered: new Set()
        };

        // 成就資料
        const achievementsData = {
            "magic_knight": {
                "name": "魔法騎士",
                "description": "與女巫達成完美結局",
                "icon": "🧙‍♀️",
                "rarity": "legendary",
                "condition": "ending_rooftop_romance",
                "points": 100
            },
            "moonlight_lover": {
                "name": "月光戀人",
                "description": "在月光湖度過浪漫夜晚",
                "icon": "🌙",
                "rarity": "epic",
                "condition": "ending_moonlight_adventure",
                "points": 90
            },
            "ghost_lover": {
                "name": "鬼魂戀人",
                "description": "與鬼魂體驗奇異親密",
                "icon": "👻",
                "rarity": "rare",
                "condition": "ending_ghost_intimacy",
                "points": 85
            },
            "pumpkin_master": {
                "name": "南瓜大師",
                "description": "在南瓜田發揮創意",
                "icon": "🎃",
                "rarity": "rare",
                "condition": "ending_big_pumpkin_fun",
                "points": 87
            },
            "field_lover": {
                "name": "田野戀人",
                "description": "與農夫女郎度過激情夜晚",
                "icon": "🌾",
                "rarity": "epic",
                "condition": "ending_physical_attraction",
                "points": 90
            },
            "cat_friend": {
                "name": "貓咪之友",
                "description": "與黑貓咪咪建立友誼",
                "icon": "🐱",
                "rarity": "common",
                "condition": "ending_cat_adventure",
                "points": 60
            },
            "cat_lady_lover": {
                "name": "貓女戀人",
                "description": "與貓女莉莉度過浪漫時光",
                "icon": "🐱‍👤",
                "rarity": "rare",
                "condition": "ending_cat_lady_romance",
                "points": 80
            },
            "soul_mate": {
                "name": "心靈伴侶",
                "description": "與農夫女郎建立情感連接",
                "icon": "💕",
                "rarity": "rare",
                "condition": "ending_heart_to_heart",
                "points": 85
            },
            "passion_lover": {
                "name": "激情戀人",
                "description": "體驗火熱的激情夜晚",
                "icon": "🔥",
                "rarity": "epic",
                "condition": "ending_physical_attraction",
                "points": 90
            },
            "cold_warrior": {
                "name": "冰冷戰士",
                "description": "勇敢面對鬼魂的冰冷觸摸",
                "icon": "❄️",
                "rarity": "common",
                "condition": "ending_cold_encounter",
                "points": 70
            },
            "floating_fool": {
                "name": "漂浮傻瓜",
                "description": "因為無禮而漂浮撞壞吊燈",
                "icon": "💥",
                "rarity": "common",
                "condition": "ending_floating_mischief",
                "points": 30
            },
            // 新增的貓咪相關成就
            "magic_master": {
                "name": "魔法大師",
                "description": "與女巫和貓女一起體驗終極魔法",
                "icon": "🔮",
                "rarity": "legendary",
                "condition": "ending_witch_cat_threesome",
                "points": 120
            },
            // 女巫道歉相關成就
            "magic_apprentice": {
                "name": "魔法學徒",
                "description": "學會了魔法世界的基本禮儀",
                "icon": "📚",
                "rarity": "common",
                "condition": "ending_witch_lessons",
                "points": 65
            },
            "pure_heart": {
                "name": "純心騎士",
                "description": "用純潔的心意贏得女巫的愛",
                "icon": "🌹",
                "rarity": "epic",
                "condition": "ending_rose_blooms",
                "points": 95
            },
            "magic_student": {
                "name": "魔法見習生",
                "description": "在女巫指導下學會愛的真諦",
                "icon": "🎭",
                "rarity": "rare",
                "condition": "ending_magic_guidance",
                "points": 75
            },
            // 鬼魂相關新成就
            "soul_lover": {
                "name": "靈魂戀人",
                "description": "與鬼魂體驗超越生死的真愛",
                "icon": "👻💖",
                "rarity": "epic",
                "condition": "ending_ghost_intimacy",
                "points": 88
            },
            "gentle_soul": {
                "name": "溫柔靈魂",
                "description": "與鬼魂建立溫柔深刻的聯繫",
                "icon": "💫",
                "rarity": "rare",
                "condition": "ending_gentle_approach",
                "points": 82
            },
            "spirit_friend": {
                "name": "靈界之友",
                "description": "與鬼魂建立跨界友誼",
                "icon": "🤝",
                "rarity": "rare",
                "condition": "ending_ghost_friendship",
                "points": 70
            },
            "understanding_master": {
                "name": "溝通大師",
                "description": "化解誤會達成相互理解",
                "icon": "🤗",
                "rarity": "rare",
                "condition": "ending_ghost_understanding",
                "points": 78
            },
            "brave_runner": {
                "name": "勇敢逃跑者",
                "description": "雖然狼狽但發現鬼魂的善良",
                "icon": "🏃‍♂️",
                "rarity": "common",
                "condition": "ending_final_chase",
                "points": 45
            },
            "heart_mentor": {
                "name": "心靈導師",
                "description": "用陪伴治癒孤獨的心靈",
                "icon": "💬",
                "rarity": "rare",
                "condition": "ending_ghost_conversation",
                "points": 73
            },
            // 鬼魂特殊技巧成就
            "soul_master": {
                "name": "靈魂大師",
                "description": "掌握靈魂共鳴的終極奧義",
                "icon": "✨",
                "rarity": "legendary",
                "condition": "ending_soul_resonance",
                "points": 110
            },
            "floating_master": {
                "name": "飄浮大師",
                "description": "學會飄浮術超越重力束縛",
                "icon": "🌟",
                "rarity": "epic",
                "condition": "ending_floating_lessons",
                "points": 92
            },
            "mind_piercer": {
                "name": "心靈穿透師",
                "description": "學會穿透心靈障礙的能力",
                "icon": "🚪",
                "rarity": "rare",
                "condition": "ending_wall_phasing",
                "points": 85
            },
            // 南瓜魔法相關成就
            "earth_beloved": {
                "name": "大地寵兒",
                "description": "獲得大地女神的永恆眷顧",
                "icon": "🌸",
                "rarity": "legendary",
                "condition": "ending_purple_pumpkin_mystery",
                "points": 105
            },
            "heart_listener": {
                "name": "心靈傾聽者",
                "description": "真正理解他人內心的能力",
                "icon": "💝",
                "rarity": "rare",
                "condition": "ending_silver_pumpkin_wish",
                "points": 80
            },
            // 原有成就
            "explorer": {
                "name": "探索者",
                "description": "探索了所有主要場景",
                "icon": "🗺️",
                "rarity": "rare",
                "condition": "visited_all_scenes",
                "points": 50
            },
            "completionist": {
                "name": "完美主義者",
                "description": "解鎖了所有結局",
                "icon": "🏆",
                "rarity": "legendary",
                "condition": "all_endings_unlocked",
                "points": 200
            },
            "speed_demon": {
                "name": "速度惡魔",
                "description": "在 5 分鐘內完成遊戲",
                "icon": "⚡",
                "rarity": "rare",
                "condition": "speed_run_5min",
                "points": 75
            },
            "pun_master": {
                "name": "雙關語大師",
                "description": "觸發了所有萬聖節雙關語",
                "icon": "😄",
                "rarity": "epic",
                "condition": "all_puns_triggered",
                "points": 100
            },
            "romance_expert": {
                "name": "浪漫專家",
                "description": "達成所有浪漫結局",
                "icon": "💘",
                "rarity": "rare",
                "condition": "all_romance_endings",
                "points": 80
            },
            "adventure_seeker": {
                "name": "冒險尋求者",
                "description": "嘗試了所有冒險選擇",
                "icon": "🗡️",
                "rarity": "rare",
                "condition": "all_adventure_choices",
                "points": 70
            },
            "halloween_legend": {
                "name": "萬聖節傳奇",
                "description": "獲得 1000 分以上",
                "icon": "🎃👑",
                "rarity": "legendary",
                "condition": "score_1000_plus",
                "points": 300
            },
            // 新增組合成就
            "cat_whisperer": {
                "name": "貓語者",
                "description": "解鎖所有貓咪相關結局",
                "icon": "🐾",
                "rarity": "epic",
                "condition": "all_cat_endings",
                "points": 150
            },
            "ghost_whisperer": {
                "name": "靈語者",
                "description": "解鎖所有鬼魂相關結局",
                "icon": "👻🌟",
                "rarity": "epic",
                "condition": "all_ghost_endings",
                "points": 160
            },
            "pumpkin_sage": {
                "name": "南瓜賢者",
                "description": "解鎖所有南瓜魔法結局",
                "icon": "🎃🔮",
                "rarity": "epic",
                "condition": "all_pumpkin_endings",
                "points": 140
            }
        };

        // 徽章資料
        const badgesData = {
            "first_play": {
                "name": "初來乍到",
                "description": "第一次遊玩",
                "icon": "👶",
                "rarity": "common"
            },
            "night_owl": {
                "name": "夜貓子",
                "description": "在深夜時分遊玩",
                "icon": "🦉",
                "rarity": "common"
            },
            "early_bird": {
                "name": "早起鳥",
                "description": "在清晨時分遊玩",
                "icon": "🐦",
                "rarity": "common"
            },
            "weekend_warrior": {
                "name": "週末戰士",
                "description": "在週末遊玩",
                "icon": "⚔️",
                "rarity": "common"
            },
            "repeat_player": {
                "name": "重複玩家",
                "description": "遊玩超過 5 次",
                "icon": "🔄",
                "rarity": "rare"
            },
            "social_butterfly": {
                "name": "社交蝴蝶",
                "description": "分享了 3 次成就",
                "icon": "🦋",
                "rarity": "rare"
            },
            "perfectionist": {
                "name": "完美主義者",
                "description": "單次遊戲獲得滿分",
                "icon": "💯",
                "rarity": "epic"
            },
            "lucky_charm": {
                "name": "幸運符",
                "description": "連續 3 次獲得稀有成就",
                "icon": "🍀",
                "rarity": "epic"
            },
            "halloween_spirit": {
                "name": "萬聖節精神",
                "description": "在萬聖節期間遊玩",
                "icon": "🎃",
                "rarity": "rare"
            },
            "midnight_magic": {
                "name": "午夜魔法",
                "description": "在午夜時分完成遊戲",
                "icon": "🕛",
                "rarity": "rare"
            }
        };

        // 社交平台資料
        const socialPlatforms = {
            "twitter": {
                "name": "Twitter",
                "icon": "🐦",
                "url": "https://twitter.com/intent/tweet",
                "hashtags": ["TsextAdventure", "HalloweenHaunt", "NSFWGame"]
            },
            "facebook": {
                "name": "Facebook",
                "icon": "📘",
                "url": "https://www.facebook.com/sharer/sharer.php",
                "hashtags": ["TsextAdventure", "HalloweenHaunt"]
            },
            "instagram": {
                "name": "Instagram",
                "icon": "📷",
                "url": "https://www.instagram.com/",
                "hashtags": ["#TsextAdventure", "#HalloweenHaunt", "#NSFWGame"]
            },
            "threads": {
                "name": "Threads",
                "icon": "🧵",
                "url": "https://www.threads.net/intent/post",
                "hashtags": ["#TsextAdventure", "#HalloweenHaunt"]
            },
            "line": {
                "name": "LINE",
                "icon": "💬",
                "url": "https://social-plugins.line.me/lineit/share",
                "hashtags": ["TsextAdventure", "HalloweenHaunt"]
            },
            "discord": {
                "name": "Discord",
                "icon": "💬",
                "url": "https://discord.com/",
                "hashtags": ["TsextAdventure", "HalloweenHaunt"]
            },
            "reddit": {
                "name": "Reddit",
                "icon": "🤖",
                "url": "https://reddit.com/submit",
                "hashtags": ["TsextAdventure", "HalloweenHaunt", "NSFWGame"]
            },
            "telegram": {
                "name": "Telegram",
                "icon": "✈️",
                "url": "https://t.me/share/url",
                "hashtags": ["TsextAdventure", "HalloweenHaunt"]
            }
        };

        // 故事資料
        const storyData = {
            "start": {
                "title": "萬聖節靈異約會趴入口",
                "description": "你站在一棟陰森的老宅前，門口掛著「歡迎參加萬聖節靈異約會趴」的牌子。月光透過烏雲灑下，南瓜燈在風中搖曳，發出詭異的光芒。\n\n你聽到屋內傳來笑聲、音樂聲，還有一些... 奇怪的聲音。門口站著一個穿著性感女巫裝的接待員，她對你眨了眨眼。",
                "choices": [
                    {"option": "A: 對女巫說「你的掃帚真漂亮，能騎嗎？」", "next_scene": "witch_encounter"},
                    {"option": "B: 直接進入鬼屋探險", "next_scene": "haunted_house"},
                    {"option": "C: 先去南瓜田看看", "next_scene": "pumpkin_patch"}
                ]
            },
            "witch_encounter": {
                "title": "女巫的誘惑",
                "description": "女巫咯咯笑著說：「當然可以騎，但你要小心不要被掃帚柄... 你知道的。」她揮了揮手，掃帚突然飛到你面前。\n\n「不過，」她神秘地笑著，「我的掃帚很挑剔，只有真正勇敢的人才能駕馭它。」",
                "choices": [
                    {"option": "A: 勇敢地跨上掃帚", "next_scene": "broom_ride_success"},
                    {"option": "B: 說「我更想騎你」", "next_scene": "witch_rejection"},
                    {"option": "C: 問「你的貓咪在哪裡？」", "next_scene": "cat_encounter"}
                ]
            },
            "broom_ride_success": {
                "title": "掃帚飛行成功",
                "description": "你成功跨上掃帚，它載著你在月光下飛翔！女巫在下面鼓掌：「太棒了！你是我見過最勇敢的騎士！」\n\n你們一起飛到屋頂，看著下面的派對。女巫靠近你，輕聲說：「現在... 讓我們做一些更刺激的事情。」",
                "choices": [
                    {"option": "A: 在屋頂上親吻女巫", "next_scene": "rooftop_romance"},
                    {"option": "B: 提議一起飛到更遠的地方", "next_scene": "moonlight_adventure"}
                ]
            },
            "rooftop_romance": {
                "title": "屋頂浪漫",
                "description": "在月光下，你和女巫在屋頂上擁吻。她的嘴唇溫暖而甜蜜，帶著魔法的味道。突然，她推開你，笑著說：「現在讓我們做一些真正的魔法！」\n\n她揮動魔杖，你們周圍出現了閃爍的星星，整個世界都變得浪漫起來。",
                "is_ending": true,
                "outcome": "🎉 完美結局！你和女巫在魔法星光下度過了難忘的萬聖節夜晚！\n\n你獲得了『魔法騎士』的稱號，並且學會了真正的愛情魔法。",
                "score": 100
            },
            "moonlight_adventure": {
                "title": "月光冒險",
                "description": "你們飛到更遠的地方，來到一個隱秘的月光湖。女巫說：「這裡是我的秘密花園，只有真正特別的人才能來到這裡。」\n\n在月光下，你們一起探索著彼此的內心，度過了最浪漫的夜晚。",
                "is_ending": true,
                "outcome": "🌙 浪漫結局！你和女巫在月光湖度過了最美好的時光！\n\n你獲得了『月光戀人』的稱號，並且永遠記住了這個神奇的夜晚。",
                "score": 90
            },
            "witch_rejection": {
                "title": "女巫的拒絕",
                "description": "女巫皺起眉頭：「你以為我是什麼？隨便的女巫嗎？」她揮動魔杖，你突然感覺身體變輕了...\n\n「既然你這麼無禮，就讓你體驗一下真正的『輕如羽毛』吧！」你開始飄浮在空中，無法控制方向。",
                "choices": [
                    {"option": "A: 道歉並請求原諒", "next_scene": "apology_accepted"},
                    {"option": "B: 試圖抓住什麼東西", "next_scene": "floating_mischief"}
                ]
            },
            "floating_mischief": {
                "title": "漂浮惡作劇",
                "description": "你試圖抓住什麼東西，但只能在空中飄浮。女巫在下面笑著：「這就是無禮的代價！」\n\n突然，你撞到了一個吊燈，燈泡爆裂，火花四濺。女巫驚叫：「我的天！快下來！」她揮動魔杖，你安全地降落到地面。",
                "is_ending": true,
                "outcome": "💥 搞笑結局！你因為無禮而漂浮，最後撞壞了吊燈！\n\n雖然結局有點尷尬，但至少你學會了對女巫要有禮貌。",
                "score": 30
            },
            "haunted_house": {
                "title": "鬼屋內部",
                "description": "你走進鬼屋，裡面燈光昏暗，牆上掛著古老的畫像。突然，一個半透明的鬼魂從牆壁中飄出來！\n\n「歡迎來到我的家，」鬼魂說，「我是這裡的主人，已經死了 200 年了。但我還是很... 活躍。」他對你眨了眨眼。",
                "choices": [
                    {"option": "A: 說「你看起來很寂寞」", "next_scene": "ghost_romance"},
                    {"option": "B: 問「你能觸摸實體嗎？」", "next_scene": "ghost_touch"},
                    {"option": "C: 試圖逃跑", "next_scene": "ghost_chase"}
                ]
            },
            "ghost_romance": {
                "title": "鬼魂的浪漫",
                "description": "鬼魂嘆了口氣：「是的，我確實很寂寞。200 年來，沒有人願意和我... 你知道的。」他的聲音帶著渴望。\n\n「但是，」他突然興奮地說，「如果你願意，我可以教你一些鬼魂的... 特殊技巧。」",
                "choices": [
                    {"option": "A: 說「我很感興趣」", "next_scene": "ghost_lessons"},
                    {"option": "B: 問「會不會很冷？」", "next_scene": "cold_encounter"}
                ]
            },
            "cold_encounter": {
                "title": "冰冷的相遇",
                "description": "鬼魂笑著說：「一開始會有點冷，但很快就會變暖的。讓我示範給你看...」\n\n他輕輕觸摸你的手，你感覺到一陣涼意，但同時又有一種奇異的溫暖。他的觸摸讓你感到既刺激又舒適。",
                "is_ending": true,
                "outcome": "❄️ 冰冷結局！你和鬼魂度過了奇異的夜晚！\n\n雖然有點冷，但你體驗到了前所未有的感覺。",
                "score": 70
            },
            "pumpkin_patch": {
                "title": "南瓜田的誘惑",
                "description": "你來到南瓜田，月光下的大南瓜看起來格外誘人。突然，一個穿著農夫裝的性感女郎從南瓜後面走出來。\n\n「歡迎來到我的南瓜田，」她說，「我是這裡的守護者。這些南瓜都很特別... 它們會回應你的慾望。」",
                "choices": [
                    {"option": "A: 問「南瓜會回應什麼慾望？」", "next_scene": "pumpkin_magic"},
                    {"option": "B: 說「我更想了解你」", "next_scene": "farmer_romance"}
                ]
            },
            "farmer_romance": {
                "title": "農夫的浪漫",
                "description": "農夫女郎對你的直接感到驚訝，然後笑了。「你很有趣，」她說，「我喜歡直接的人。」\n\n她靠近你，輕聲說：「那麼，你想要了解我的哪個方面呢？」她的眼睛閃爍著誘惑的光芒。",
                "choices": [
                    {"option": "A: 說「我想了解你的心」", "next_scene": "heart_to_heart"},
                    {"option": "B: 說「我想了解你的身體」", "next_scene": "physical_attraction"}
                ]
            },
            "heart_to_heart": {
                "title": "心靈交流",
                "description": "農夫女郎對你的回答感到感動。「你是一個真正的人，」她說，「我願意和你分享我的內心。」\n\n你們坐在南瓜田邊，分享著彼此的故事和夢想，度過了最美好的時光。",
                "is_ending": true,
                "outcome": "💕 心靈結局！你和農夫女郎建立了深厚的情感連接！\n\n你獲得了『心靈伴侶』的稱號，並且永遠記住了這個美好的夜晚。",
                "score": 85
            },
            "physical_attraction": {
                "title": "身體吸引",
                "description": "農夫女郎對你的直接感到興奮。「很好，」她說，「我喜歡誠實的人。」\n\n她拉著你的手，帶你到南瓜田的深處。「讓我們做一些真正有趣的事情，」她輕聲說。",
                "is_ending": true,
                "outcome": "🔥 激情結局！你和農夫女郎度過了火熱的夜晚！\n\n你獲得了『激情戀人』的稱號，並且永遠記住了這個充滿激情的夜晚。",
                "score": 90
            },
            "cat_encounter": {
                "title": "神秘貓咪",
                "description": "女巫神秘地笑了：「咪咪？她很特別，不是普通的貓。」突然，一隻優雅的黑貓從陰影中走出，牠的眼睛在月光下閃閃發光。\n\n貓咪變身成一個貓女，有著性感的耳朵和尾巴。「我是莉莉，」她用誘人的聲音說，「想和我玩嗎？」",
                "choices": [
                    {"option": "A: 說「我很想和你玩」", "next_scene": "cat_lady_romance"},
                    {"option": "B: 問「你能變回貓咪嗎？」", "next_scene": "cat_adventure"},
                    {"option": "C: 邀請女巫一起加入", "next_scene": "witch_cat_threesome"}
                ]
            },
            "cat_lady_romance": {
                "title": "貓女的誘惑",
                "description": "莉莉優雅地靠近你，她的尾巴輕撫著你的臉頰。「我喜歡你的勇氣，」她輕聲說，眼中閃爍著野性的光芒。\n\n她帶你到一個舒適的角落，月光透過窗戶灑在你們身上。「讓我教你貓咪的... 特殊技巧。」",
                "is_ending": true,
                "outcome": "🐱‍👤 貓女結局！你與貓女莉莉度過了充滿野性魅力的夜晚！\n\n你獲得了『貓女戀人』的稱號，學會了貓咪般的優雅與激情。",
                "score": 80
            },
            "cat_adventure": {
                "title": "貓咪冒險",
                "description": "莉莉笑著變回了可愛的黑貓咪咪。她跳到你的肩膀上，用頭蹭蹭你的臉頰。\n\n「咪咪很喜歡你，」女巫說，「她想帶你去探索這個神奇的地方。」咪咪開始引導你走向一個隱秘的花園。",
                "is_ending": true,
                "outcome": "🐱 貓咪結局！你和黑貓咪咪建立了純潔的友誼！\n\n你獲得了『貓咪之友』的稱號，並且獲得了貓咪的信任與友誼。",
                "score": 60
            },
            "witch_cat_threesome": {
                "title": "魔法三重奏",
                "description": "女巫和莉莉對視一眼，都笑了。「有趣的提議，」女巫說，「不是每個人都能同時承受我們兩個的魔力。」\n\n莉莉變回貓女形態，三人在月光下開始了一場奇異的魔法儀式，充滿了神秘與激情。",
                "is_ending": true,
                "outcome": "🔮 魔法三重結局！你與女巫和貓女莉莉一起度過了終生難忘的魔法夜晚！\n\n你獲得了『魔法大師』的稱號，掌握了最高級的愛情魔法。",
                "score": 120
            },
            "apology_accepted": {
                "title": "真誠的道歉",
                "description": "你在空中誠懇地道歉：「對不起，我不應該那麼無禮。請原諒我的冒昧。」\n\n女巫看到你真誠的悔意，臉色軟化了。「好吧，至少你知道錯了。」她輕揮魔杖，讓你緩緩降落。「現在，讓我教你如何正確地與女巫交流。」",
                "choices": [
                    {"option": "A: 謙遜地學習禮儀", "next_scene": "witch_lessons"},
                    {"option": "B: 請求第二次機會", "next_scene": "second_chance_romance"}
                ]
            },
            "witch_lessons": {
                "title": "女巫的教導",
                "description": "女巫耐心地教你魔法世界的禮儀和規矩。「尊重是一切關係的基礎，」她說，「無論是愛情還是友情。」\n\n在她的指導下，你學會了如何與魔法生物相處，這將是你珍貴的人生經驗。",
                "is_ending": true,
                "outcome": "📚 學習結局！你從女巫那裡學會了寶貴的人生課程！\n\n你獲得了『魔法學徒』的稱號，掌握了基本的魔法禮儀。",
                "score": 65
            },
            "second_chance_romance": {
                "title": "第二次機會",
                "description": "女巫考慮了一會兒：「每個人都值得第二次機會，」她溫和地說，「但這次你必須證明你的真心。」\n\n她給了你一朵魔法玫瑰：「如果你能讓這朵花在午夜前綻放，我就相信你的誠意。」",
                "choices": [
                    {"option": "A: 用真心澆灌玫瑰", "next_scene": "rose_blooms"},
                    {"option": "B: 詢問澆灌的方法", "next_scene": "magic_guidance"}
                ]
            },
            "rose_blooms": {
                "title": "玫瑰綻放",
                "description": "你將所有的真誠和愛意注入玫瑰中。奇蹟發生了！玫瑰在你手中慢慢綻放，散發出迷人的魔法光芒。\n\n女巫驚訝地看著這一切：「我從未見過如此純潔的心靈能量。你真的讓我刮目相看。」",
                "is_ending": true,
                "outcome": "🌹 真心結局！你用純潔的心意贏得了女巫的尊重與愛情！\n\n你獲得了『純心騎士』的稱號，證明了真愛的力量。",
                "score": 95
            },
            "magic_guidance": {
                "title": "魔法指導",
                "description": "女巫微笑著指導你：「魔法玫瑰需要的不是水，而是情感的共鳴。將你最美好的回憶和感情傳遞給它。」\n\n在她的幫助下，你成功讓玫瑰綻放，兩人在過程中建立了深厚的情誼。",
                "is_ending": true,
                "outcome": "🎭 師生結局！在女巫的指導下，你學會了愛的真諦！\n\n你獲得了『魔法見習生』的稱號，掌握了情感魔法的基礎。",
                "score": 75
            },
            "ghost_touch": {
                "title": "鬼魂的觸摸",
                "description": "鬼魂展示他半透明的手：「我可以觸摸實體，但感覺會很... 特別。」他輕撫你的臉頰，你感到一陣奇異的涼意伴隨著電流般的刺激。\n\n「200年的孤獨讓我對觸摸格外渴望，」他輕聲說，「你願意體驗這種超越生死的親密接觸嗎？」",
                "choices": [
                    {"option": "A: 說「我願意體驗」", "next_scene": "ghost_intimacy"},
                    {"option": "B: 問「會有什麼後果嗎？」", "next_scene": "ghost_consequences"},
                    {"option": "C: 提議慢慢來", "next_scene": "gentle_approach"}
                ]
            },
            "ghost_intimacy": {
                "title": "超越生死的親密",
                "description": "你勇敢地接受了鬼魂的觸摸。那種感覺難以形容 - 既冰冷又溫暖，既虛幻又真實。你們在這種奇異的接觸中找到了彼此。\n\n鬼魂感動地說：「200年來，你是第一個真正接受我的人。這比任何魔法都要珍貴。」",
                "is_ending": true,
                "outcome": "👻 靈魂結局！你與鬼魂體驗了超越生死的真愛！\n\n你獲得了『靈魂戀人』的稱號，證明了愛情能夠跨越生死界限。",
                "score": 88
            },
            "ghost_consequences": {
                "title": "鬼魂的警告",
                "description": "鬼魂誠實地告訴你：「與鬼魂親密接觸可能會讓你對靈界更敏感，但也會讓你更理解生命的珍貴。」\n\n他給你選擇的權利：「決定權在你，我不會強迫任何人。但如果你願意，我保證這會是你最難忘的經歷。」",
                "choices": [
                    {"option": "A: 決定冒險一試", "next_scene": "ghost_intimacy"},
                    {"option": "B: 選擇只做朋友", "next_scene": "ghost_friendship"}
                ]
            },
            "gentle_approach": {
                "title": "溫柔的開始",
                "description": "鬼魂欣賞你的謹慎：「你很聰明，急躁從來不是好事。」他溫柔地握住你的手，讓你慢慢適應這種奇特的感覺。\n\n「我們有整夜的時間，」他溫柔地說，「讓我們慢慢探索彼此的世界。」",
                "is_ending": true,
                "outcome": "💫 溫柔結局！你與鬼魂建立了溫柔而深刻的聯繫！\n\n你獲得了『溫柔靈魂』的稱號，學會了耐心與理解的重要。",
                "score": 82
            },
            "ghost_friendship": {
                "title": "跨界友誼",
                "description": "鬼魂對你的決定表示理解：「友誼也是一種珍貴的關係，」他說，「我很高興能有一個活人朋友。」\n\n你們度過了一個充滿趣味對話的夜晚，分享著生與死的不同體驗，建立了跨越界限的友誼。",
                "is_ending": true,
                "outcome": "🤝 友誼結局！你與鬼魂建立了珍貴的跨界友誼！\n\n你獲得了『靈界之友』的稱號，證明了友誼無界限。",
                "score": 70
            },
            "ghost_chase": {
                "title": "鬼魂追逐",
                "description": "你轉身就跑！但鬼魂的速度比你想像的要快。「別跑啊！我只是想聊聊天！」他在後面大喊。\n\n你跑得太急，被地毯絆倒了。鬼魂追上來，擔心地問：「你沒事吧？我真的沒有惡意，只是太久沒見到活人了...」",
                "choices": [
                    {"option": "A: 道歉並解釋你的恐懼", "next_scene": "ghost_understanding"},
                    {"option": "B: 繼續試圖逃跑", "next_scene": "final_chase"},
                    {"option": "C: 問他真正想要什麼", "next_scene": "ghost_honesty"}
                ]
            },
            "ghost_understanding": {
                "title": "相互理解",
                "description": "你坦誠地說出了你的害怕，鬼魂理解地點頭：「我忘了對活人來說，鬼魂確實很可怕。我太孤獨了，有點太急切了。」\n\n他真誠地道歉，你們開始了正常的對話，逐漸建立起理解與信任。",
                "is_ending": true,
                "outcome": "🤗 理解結局！透過坦誠溝通，你與鬼魂達成了相互理解！\n\n你獲得了『溝通大師』的稱號，學會了化解誤會的技巧。",
                "score": 78
            },
            "final_chase": {
                "title": "最終追逐",
                "description": "你繼續逃跑，但在一個轉角處摔了一跤。鬼魂終於追上了你，但他沒有傷害你，而是關心地檢查你的傷勢。\n\n「看，我真的沒有惡意，」他無奈地說，「如果我想傷害你，根本不需要追逐。我只是... 太寂寞了。」",
                "is_ending": true,
                "outcome": "🏃‍♂️ 追逐結局！雖然一陣驚嚇，但你最終發現鬼魂其實很善良！\n\n你獲得了『勇敢逃跑者』的稱號，雖然過程有些狼狽。",
                "score": 45
            },
            "ghost_honesty": {
                "title": "鬼魂的真心話",
                "description": "鬼魂嘆了口氣：「我只是想要有人陪伴。200年的孤獨太漫長了，我幾乎忘記了與人交流的感覺。」\n\n他的誠實打動了你：「我不會強迫你做任何事，如果你真的害怕，你可以離開。但如果你願意聊聊天... 那將是我這個世紀最大的快樂。」",
                "choices": [
                    {"option": "A: 同意陪他聊天", "next_scene": "ghost_conversation"},
                    {"option": "B: 提議成為朋友", "next_scene": "ghost_friendship"}
                ]
            },
            "ghost_conversation": {
                "title": "深夜談心",
                "description": "你決定陪鬼魂聊天。他分享了200年來的孤獨歲月，你則講述了現代世界的變化。\n\n時間在對話中飛快流逝，你們從陌生到熟悉，建立了一種特殊的聯繫。黎明時分，你們已經像老朋友一樣了。",
                "is_ending": true,
                "outcome": "💬 談話結局！通過深夜的談心，你為鬼魂帶來了久違的溫暖！\n\n你獲得了『心靈導師』的稱號，用陪伴治癒了一顆孤獨的心。",
                "score": 73
            },
            "ghost_lessons": {
                "title": "鬼魂的特殊技巧",
                "description": "鬼魂興奮地開始教你：「作為鬼魂，我掌握了一些... 特別的技能。比如穿牆術、飄浮術，還有最重要的 - 靈魂共鳴術。」\n\n他教你如何感受靈魂的振動，如何在精神層面建立深度連接。這種體驗超越了肉體的限制。",
                "choices": [
                    {"option": "A: 專注學習靈魂共鳴", "next_scene": "soul_resonance"},
                    {"option": "B: 要求學習飄浮術", "next_scene": "floating_lessons"},
                    {"option": "C: 詢問穿牆術的秘密", "next_scene": "wall_phasing"}
                ]
            },
            "soul_resonance": {
                "title": "靈魂共鳴",
                "description": "在鬼魂的指導下，你學會了靈魂共鳴。兩個靈魂在精神層面完美融合，產生了前所未有的親密感。\n\n這種體驗超越了肉體的愛情，直達靈魂深處。你們在這種神聖的連結中找到了永恆的愛。",
                "is_ending": true,
                "outcome": "✨ 靈魂共鳴結局！你與鬼魂達成了最高級的靈魂融合！\n\n你獲得了『靈魂大師』的稱號，掌握了靈魂共鳴的終極奧義。",
                "score": 110
            },
            "floating_lessons": {
                "title": "飄浮術教學",
                "description": "鬼魂教你如何讓靈魂脫離肉體的束縛：「重點是放空心靈，讓意識與重力分離。」\n\n在他的指導下，你居然真的飄浮了起來！兩人在空中擁抱，體驗著超越重力的自由與愛情。",
                "is_ending": true,
                "outcome": "🌟 飄浮結局！你學會了飄浮術，與鬼魂在空中度過了浪漫時光！\n\n你獲得了『飄浮大師』的稱號，掌握了超越重力的能力。",
                "score": 92
            },
            "wall_phasing": {
                "title": "穿牆術奧秘",
                "description": "鬼魂揭示了穿牆術的秘密：「關鍵是理解物質的本質，讓分子重新排列。」雖然你無法完全學會，但理解了這個原理。\n\n更重要的是，鬼魂教會了你如何「穿透」心靈的障礙，建立更深層的情感連接。",
                "is_ending": true,
                "outcome": "🚪 穿透結局！雖然無法穿牆，但你學會了穿透心靈的障礙！\n\n你獲得了『心靈穿透師』的稱號，掌握了理解他人內心的能力。",
                "score": 85
            },
            "pumpkin_magic": {
                "title": "南瓜的魔法",
                "description": "農夫女郎神秘地笑著：「這些南瓜吸收了月光精華，能夠實現人們最深層的願望。但要小心，」她警告道，「它們會讓你的慾望成真，包括那些你不敢承認的。」\n\n她指向幾個特別大的南瓜：「選擇一個，讓它讀取你的心願吧。」",
                "choices": [
                    {"option": "A: 選擇最大的金色南瓜", "next_scene": "big_pumpkin_fun"},
                    {"option": "B: 選擇神秘的紫色南瓜", "next_scene": "purple_pumpkin_mystery"},
                    {"option": "C: 選擇小巧的銀色南瓜", "next_scene": "silver_pumpkin_wish"}
                ]
            },
            "big_pumpkin_fun": {
                "title": "巨大南瓜的驚喜",
                "description": "你觸摸大南瓜的瞬間，它開始發光並且慢慢變形。最終，南瓜變成了一個豪華的愛情巢穴，裡面鋪滿了柔軟的絲綢和玫瑰花瓣。\n\n農夫女郎驚訝地說：「哇！南瓜很少變成這麼... 實用的東西。看來你的願望很明確呢。」",
                "is_ending": true,
                "outcome": "🎃 大南瓜結局！巨大南瓜為你創造了完美的浪漫空間！\n\n你獲得了『南瓜大師』的稱號，學會了如何讓願望成真。",
                "score": 87
            },
            "purple_pumpkin_mystery": {
                "title": "紫色南瓜的秘密",
                "description": "紫色南瓜散發出神秘的薰衣草香味，當你觸摸它時，突然看到了農夫女郎的真實身份 - 她是大地女神的化身！\n\n「你發現了我的秘密，」她微笑著顯現出女神的光輝，「作為獎賞，我將賜予你大地的祝福與永恆的豐收。」",
                "is_ending": true,
                "outcome": "🌸 女神結局！你發現了農夫女郎的真實身份，獲得了女神的祝福！\n\n你獲得了『大地寵兒』的稱號，得到了女神永恆的眷顧。",
                "score": 105
            },
            "silver_pumpkin_wish": {
                "title": "銀色南瓜的願望",
                "description": "小巧的銀色南瓜在你手中溫暖地跳動，就像一顆心臟。突然，你感受到了農夫女郎內心真正的願望 - 她希望有人能真正理解她對土地的愛。\n\n「你感受到了，」她感動地說，「很少有人能理解我對這片土地的深情。謝謝你願意傾聽我的心聲。」",
                "is_ending": true,
                "outcome": "💝 心願結局！你理解了農夫女郎的真心，建立了心靈的默契！\n\n你獲得了『心靈傾聽者』的稱號，學會了真正理解他人的能力。",
                "score": 80
            }
        };

        // 載入遊戲資料
        function loadGameData() {
            const saved = localStorage.getItem('tsextAdventureData');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.unlockedAchievements = new Set(data.unlockedAchievements || []);
                gameState.unlockedBadges = new Set(data.unlockedBadges || []);
                gameState.playCount = data.playCount || 0;
                gameState.totalScore = data.totalScore || 0;
                gameState.allEndingsUnlocked = new Set(data.allEndingsUnlocked || []);
                gameState.allScenesVisited = new Set(data.allScenesVisited || []);
                gameState.punsTriggered = new Set(data.punsTriggered || []);
            }
        }

        // 儲存遊戲資料
        function saveGameData() {
            const data = {
                unlockedAchievements: Array.from(gameState.unlockedAchievements),
                unlockedBadges: Array.from(gameState.unlockedBadges),
                playCount: gameState.playCount,
                totalScore: gameState.totalScore,
                allEndingsUnlocked: Array.from(gameState.allEndingsUnlocked),
                allScenesVisited: Array.from(gameState.allScenesVisited),
                punsTriggered: Array.from(gameState.punsTriggered)
            };
            localStorage.setItem('tsextAdventureData', JSON.stringify(data));
        }

        // 檢查成就
        function checkAchievements(sceneId) {
            const newAchievements = [];
            
            // 檢查結局成就
            if (storyData[sceneId] && storyData[sceneId].is_ending) {
                const endingCondition = `ending_${sceneId}`;
                for (const [achievementId, achievement] of Object.entries(achievementsData)) {
                    if (achievement.condition === endingCondition && !gameState.unlockedAchievements.has(achievementId)) {
                        gameState.unlockedAchievements.add(achievementId);
                        newAchievements.push(achievementId);
                    }
                }
            }

            // 檢查特殊成就
            checkSpecialAchievements();

            // 顯示新成就
            newAchievements.forEach(achievementId => {
                showAchievementPopup(achievementId);
            });

            // 更新成就面板
            updateAchievementsPanel();
            updateStatsPanel();
            saveGameData();
        }

        // 檢查特殊成就
        function checkSpecialAchievements() {
            // 探索者成就
            if (gameState.visitedScenes.size >= 15 && !gameState.unlockedAchievements.has('explorer')) {
                gameState.unlockedAchievements.add('explorer');
                showAchievementPopup('explorer');
            }

            // 完美主義者成就 - 現在有更多結局了
            if (gameState.allEndingsUnlocked.size >= 20 && !gameState.unlockedAchievements.has('completionist')) {
                gameState.unlockedAchievements.add('completionist');
                showAchievementPopup('completionist');
            }

            // 速度惡魔成就
            if (gameState.gameStartTime) {
                const playTime = (Date.now() - gameState.gameStartTime) / 1000 / 60; // 分鐘
                if (playTime <= 5 && !gameState.unlockedAchievements.has('speed_demon')) {
                    gameState.unlockedAchievements.add('speed_demon');
                    showAchievementPopup('speed_demon');
                }
            }

            // 萬聖節傳奇成就
            if (gameState.totalScore >= 1000 && !gameState.unlockedAchievements.has('halloween_legend')) {
                gameState.unlockedAchievements.add('halloween_legend');
                showAchievementPopup('halloween_legend');
            }

            // 貓語者成就 - 解鎖所有貓咪相關結局
            const catEndings = ['cat_adventure', 'cat_lady_romance', 'witch_cat_threesome'];
            if (catEndings.every(ending => gameState.allEndingsUnlocked.has(ending)) && 
                !gameState.unlockedAchievements.has('cat_whisperer')) {
                gameState.unlockedAchievements.add('cat_whisperer');
                showAchievementPopup('cat_whisperer');
            }

            // 靈語者成就 - 解鎖所有鬼魂相關結局
            const ghostEndings = ['cold_encounter', 'ghost_intimacy', 'gentle_approach', 'ghost_friendship', 
                                'ghost_understanding', 'final_chase', 'ghost_conversation', 'soul_resonance', 
                                'floating_lessons', 'wall_phasing'];
            if (ghostEndings.filter(ending => gameState.allEndingsUnlocked.has(ending)).length >= 6 && 
                !gameState.unlockedAchievements.has('ghost_whisperer')) {
                gameState.unlockedAchievements.add('ghost_whisperer');
                showAchievementPopup('ghost_whisperer');
            }

            // 南瓜賢者成就 - 解鎖所有南瓜魔法結局
            const pumpkinEndings = ['heart_to_heart', 'physical_attraction', 'big_pumpkin_fun', 
                                  'purple_pumpkin_mystery', 'silver_pumpkin_wish'];
            if (pumpkinEndings.filter(ending => gameState.allEndingsUnlocked.has(ending)).length >= 3 && 
                !gameState.unlockedAchievements.has('pumpkin_sage')) {
                gameState.unlockedAchievements.add('pumpkin_sage');
                showAchievementPopup('pumpkin_sage');
            }

            // 浪漫專家成就 - 達成所有高分浪漫結局
            const romanceEndings = ['rooftop_romance', 'moonlight_adventure', 'heart_to_heart', 
                                  'physical_attraction', 'cat_lady_romance', 'witch_cat_threesome',
                                  'rose_blooms', 'ghost_intimacy', 'soul_resonance'];
            if (romanceEndings.filter(ending => gameState.allEndingsUnlocked.has(ending)).length >= 5 && 
                !gameState.unlockedAchievements.has('romance_expert')) {
                gameState.unlockedAchievements.add('romance_expert');
                showAchievementPopup('romance_expert');
            }

            // 冒險尋求者成就 - 嘗試了所有主要分支
            const adventureScenes = ['witch_encounter', 'haunted_house', 'pumpkin_patch', 'cat_encounter', 
                                   'ghost_touch', 'ghost_chase', 'pumpkin_magic', 'ghost_lessons'];
            if (adventureScenes.filter(scene => gameState.allScenesVisited.has(scene)).length >= 6 && 
                !gameState.unlockedAchievements.has('adventure_seeker')) {
                gameState.unlockedAchievements.add('adventure_seeker');
                showAchievementPopup('adventure_seeker');
            }
        }

        // 檢查徽章
        function checkBadges() {
            const newBadges = [];
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();

            // 第一次遊玩
            if (gameState.playCount === 1 && !gameState.unlockedBadges.has('first_play')) {
                gameState.unlockedBadges.add('first_play');
                newBadges.push('first_play');
            }

            // 夜貓子
            if ((hour >= 22 || hour <= 2) && !gameState.unlockedBadges.has('night_owl')) {
                gameState.unlockedBadges.add('night_owl');
                newBadges.push('night_owl');
            }

            // 早起鳥
            if (hour >= 5 && hour <= 8 && !gameState.unlockedBadges.has('early_bird')) {
                gameState.unlockedBadges.add('early_bird');
                newBadges.push('early_bird');
            }

            // 週末戰士
            if ((day === 0 || day === 6) && !gameState.unlockedBadges.has('weekend_warrior')) {
                gameState.unlockedBadges.add('weekend_warrior');
                newBadges.push('weekend_warrior');
            }

            // 重複玩家
            if (gameState.playCount >= 5 && !gameState.unlockedBadges.has('repeat_player')) {
                gameState.unlockedBadges.add('repeat_player');
                newBadges.push('repeat_player');
            }

            // 午夜魔法
            if (hour === 0 && !gameState.unlockedBadges.has('midnight_magic')) {
                gameState.unlockedBadges.add('midnight_magic');
                newBadges.push('midnight_magic');
            }

            return newBadges;
        }

        // 顯示成就彈窗
        function showAchievementPopup(achievementId) {
            const achievement = achievementsData[achievementId];
            if (!achievement) return;

            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = () => closeAchievementPopup();

            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-title">🏆 成就解鎖！</div>
                <div class="achievement-description">${achievement.name}</div>
                <div class="achievement-rarity rarity-${achievement.rarity}">${achievement.rarity.toUpperCase()}</div>
                <div class="achievement-description">${achievement.description}</div>
                <div class="achievement-actions">
                    <button class="share-btn" onclick="downloadAchievementImage('${achievementId}')">下載圖片 📥</button>
                    <button class="share-btn" onclick="shareAchievement('${achievementId}')">分享成就 📤</button>
                    <button class="close-btn" onclick="closeAchievementPopup()">關閉</button>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(popup);

            // 3秒後自動關閉
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    closeAchievementPopup();
                }
            }, 5000);
        }

        // 關閉成就彈窗
        function closeAchievementPopup() {
            const overlay = document.querySelector('.overlay');
            const popup = document.querySelector('.achievement-popup');
            if (overlay) overlay.remove();
            if (popup) popup.remove();
        }

        // 分享成就
        function shareAchievement(achievementId) {
            const achievement = achievementsData[achievementId];
            const shareText = `🎃 我在 Tsext Adventure: Halloween Haunt 中解鎖了成就「${achievement.name}」！\n\n${achievement.description}\n\n#TsextAdventure #HalloweenHaunt #NSFWGame`;
            const shareUrl = window.location.href;

            showShareModal(shareText, shareUrl, achievement);
        }

        // 下載成就圖片
        function downloadAchievementImage(achievementId) {
            const achievement = achievementsData[achievementId];
            if (!achievement) return;

            // 創建 canvas 元素
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 設定 canvas 尺寸 (社交媒體適用尺寸)
            canvas.width = 800;
            canvas.height = 600;

            // 創建漸層背景
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 添加邊框效果
            ctx.strokeStyle = '#ff6b35';
            ctx.lineWidth = 8;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);

            // 內層邊框
            ctx.strokeStyle = 'rgba(139, 92, 246, 0.8)';
            ctx.lineWidth = 4;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);

            // 遊戲標題
            ctx.fillStyle = '#ff6b35';
            ctx.font = 'bold 32px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText('🎃 Tsext Adventure: Halloween Haunt 🎃', canvas.width / 2, 100);

            // 成就解鎖文字
            ctx.fillStyle = '#8b5cf6';
            ctx.font = 'bold 24px "Courier New", monospace';
            ctx.fillText('🏆 成就解鎖！', canvas.width / 2, 150);

            // 成就圖標 (放大)
            ctx.font = '120px Arial';
            ctx.fillText(achievement.icon, canvas.width / 2, 280);

            // 成就名稱
            ctx.fillStyle = '#ff6b35';
            ctx.font = 'bold 36px "Courier New", monospace';
            ctx.fillText(achievement.name, canvas.width / 2, 350);

            // 稀有度標籤
            const rarityColors = {
                'common': '#9CA3AF',
                'rare': '#3B82F6', 
                'epic': '#8B5CF6',
                'legendary': '#F59E0B'
            };
            
            ctx.fillStyle = rarityColors[achievement.rarity] || '#9CA3AF';
            ctx.font = 'bold 20px "Courier New", monospace';
            ctx.fillText(`【 ${achievement.rarity.toUpperCase()} 】`, canvas.width / 2, 390);

            // 成就描述 (自動換行)
            ctx.fillStyle = '#e0e0e0';
            ctx.font = '18px "Courier New", monospace';
            const maxWidth = canvas.width - 120;
            const lineHeight = 25;
            const words = achievement.description.split('');
            let line = '';
            let y = 440;

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i];
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    ctx.fillText(line, canvas.width / 2, y);
                    line = words[i];
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, canvas.width / 2, y);

            // 分數資訊
            if (achievement.points) {
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 20px "Courier New", monospace';
                ctx.fillText(`💎 ${achievement.points} 分`, canvas.width / 2, y + 50);
            }

            // 底部裝飾
            ctx.fillStyle = '#8b5cf6';
            ctx.font = '16px "Courier New", monospace';
            ctx.fillText('github.com/dennislee928/tsext-adventure', canvas.width / 2, canvas.height - 50);

            // 下載圖片
            const link = document.createElement('a');
            link.download = `tsext-adventure-achievement-${achievement.name.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

            // 顯示成功提示
            showSuccessNotification(`🎉 成就圖片已下載：${achievement.name}`);
        }

        // 顯示成功通知
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 10000;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // 添加動畫樣式
            if (!document.getElementById('notification-style')) {
                const style = document.createElement('style');
                style.id = 'notification-style';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // 3 秒後自動移除
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 顯示分享模態框
        function showShareModal(text, url, achievement) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = () => closeShareModal();

            const modal = document.createElement('div');
            modal.className = 'achievement-popup';
            modal.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-title">分享成就</div>
                <div class="achievement-description">選擇分享平台：</div>
                <div class="achievement-actions">
                    ${Object.entries(socialPlatforms).map(([platformId, platform]) => `
                        <button class="share-btn" onclick="shareToPlatform('${platformId}', '${encodeURIComponent(text)}', '${encodeURIComponent(url)}')">
                            ${platform.icon} ${platform.name}
                        </button>
                    `).join('')}
                    <button class="close-btn" onclick="closeShareModal()">取消</button>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }

        // 關閉分享模態框
        function closeShareModal() {
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.achievement-popup');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
        }

        // 分享到平台
        function shareToPlatform(platformId, text, url) {
            const platform = socialPlatforms[platformId];
            let shareUrl = '';

            switch (platformId) {
                case 'twitter':
                    shareUrl = `${platform.url}?text=${text}&url=${url}`;
                    break;
                case 'facebook':
                    shareUrl = `${platform.url}?u=${url}&quote=${text}`;
                    break;
                case 'instagram':
                    // Instagram 需要手動複製
                    navigator.clipboard.writeText(`${text}\n\n${url}`);
                    alert('已複製到剪貼板！請在 Instagram 中貼上。');
                    return;
                case 'threads':
                    shareUrl = `${platform.url}?text=${text}`;
                    break;
                case 'line':
                    shareUrl = `${platform.url}?url=${url}&text=${text}`;
                    break;
                case 'reddit':
                    shareUrl = `${platform.url}?url=${url}&title=${text}`;
                    break;
                case 'telegram':
                    shareUrl = `${platform.url}?url=${url}&text=${text}`;
                    break;
                default:
                    // 複製到剪貼板
                    navigator.clipboard.writeText(`${text}\n\n${url}`);
                    alert('已複製到剪貼板！');
                    return;
            }

            window.open(shareUrl, '_blank', 'width=600,height=400');
            closeShareModal();
        }

        // 切換成就面板
        function toggleAchievementsPanel() {
            const panel = document.getElementById('achievementsPanel');
            const toggle = document.getElementById('achievementsToggle');
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                if (toggle) {
                    toggle.style.right = '0';
                }
            } else {
                panel.classList.add('open');
                if (toggle) {
                    toggle.style.right = '300px';
                }
            }
        }

        // 更新成就面板
        function updateAchievementsPanel() {
            const panel = document.getElementById('achievementsList');
            if (!panel) return;

            const unlockedCount = gameState.unlockedAchievements.size;
            const totalCount = Object.keys(achievementsData).length;
            
            let html = `
                <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: rgba(139, 92, 246, 0.2); border-radius: 8px;">
                    <div style="font-size: 1.5em; color: #ff6b35; font-weight: bold;">${unlockedCount} / ${totalCount}</div>
                    <div style="font-size: 0.9em; color: #e0e0e0;">已解鎖成就</div>
                </div>
            `;

            html += Object.entries(achievementsData).map(([achievementId, achievement]) => {
                const isUnlocked = gameState.unlockedAchievements.has(achievementId);
                return `
                    <div class="achievement-item ${isUnlocked ? 'unlocked' : ''}" style="opacity: ${isUnlocked ? '1' : '0.5'}">
                        <div class="achievement-item-icon">${achievement.icon}</div>
                        <div class="achievement-item-text">
                            <div class="achievement-item-name">${achievement.name}</div>
                            <div class="achievement-item-desc">${achievement.description}</div>
                            ${isUnlocked ? '<div style="font-size: 0.7em; color: #ff6b35; margin-top: 3px;">✓ 已解鎖</div>' : '<div style="font-size: 0.7em; color: #666; margin-top: 3px;">🔒 未解鎖</div>'}
                        </div>
                        ${isUnlocked ? `
                            <div class="achievement-item-actions" style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                                <button onclick="downloadAchievementImage('${achievementId}')" style="background: #ff6b35; border: none; border-radius: 15px; padding: 5px 10px; color: white; font-size: 0.7em; cursor: pointer; transition: all 0.2s; min-width: 60px;" onmouseover="this.style.background='#e55a2e'" onmouseout="this.style.background='#ff6b35'">📥 下載</button>
                                <button onclick="shareAchievement('${achievementId}')" style="background: #8b5cf6; border: none; border-radius: 15px; padding: 5px 10px; color: white; font-size: 0.7em; cursor: pointer; transition: all 0.2s; min-width: 60px;" onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">📤 分享</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            panel.innerHTML = html;
        }

        // 更新統計面板
        function updateStatsPanel() {
            document.getElementById('totalScore').textContent = gameState.totalScore;
            document.getElementById('playCount').textContent = gameState.playCount;
            document.getElementById('achievementCount').textContent = gameState.unlockedAchievements.size;
            document.getElementById('sceneCount').textContent = gameState.visitedScenes.size;
        }

        // 開始遊戲
        function startGame() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('請輸入你的名字！');
                return;
            }

            gameState.playerName = playerName;
            gameState.currentScene = 'start';
            gameState.score = 0;
            gameState.visitedScenes.clear();
            gameState.gameStartTime = Date.now();
            gameState.playCount++;

            // 檢查徽章
            const newBadges = checkBadges();
            if (newBadges.length > 0) {
                newBadges.forEach(badgeId => {
                    const badge = badgesData[badgeId];
                    alert(`🏆 獲得徽章：${badge.name} - ${badge.description}`);
                });
            }

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('achievementsToggle').style.display = 'block';
            
            updateStatsPanel();
            updateAchievementsPanel();
            saveGameData();
            displayScene('start');
        }

        // 顯示場景
        function displayScene(sceneId) {
            const scene = storyData[sceneId];
            if (!scene) {
                alert('找不到場景資料！');
                return;
            }

            gameState.visitedScenes.add(sceneId);
            gameState.allScenesVisited.add(sceneId);

            let html = `
                <div class="scene-title">🎃 ${scene.title} 🎃</div>
                <div class="scene-description">${scene.description.replace(/\n/g, '<br>')}</div>
            `;

            if (scene.is_ending) {
                gameState.score += scene.score || 0;
                gameState.totalScore += scene.score || 0;
                gameState.allEndingsUnlocked.add(sceneId);
                
                // 檢查成就
                checkAchievements(sceneId);

                html += `
                    <div class="ending">
                        <div class="ending-title">🎭 結局：${scene.title}</div>
                        <div class="ending-outcome">${scene.outcome.replace(/\n/g, '<br>')}</div>
                        <div class="score">🏆 你的分數：${gameState.score}</div>
                        <div class="score">📍 探索場景數：${gameState.visitedScenes.size}</div>
                        <div class="score">🎯 總分數：${gameState.totalScore}</div>
                        <button class="restart-btn" onclick="restartGame()">重新開始 🎃</button>
                    </div>
                `;
            } else if (scene.choices) {
                html += '<div class="choices">';
                scene.choices.forEach((choice, index) => {
                    html += `
                        <div class="choice" onclick="makeChoice('${choice.next_scene}')">
                            ${choice.option}
                        </div>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('gameArea').innerHTML = html;
        }

        // 做出選擇
        function makeChoice(nextScene) {
            displayScene(nextScene);
        }

        // 重新開始遊戲
        function restartGame() {
            gameState.currentScene = 'start';
            gameState.score = 0;
            gameState.visitedScenes.clear();
            gameState.gameStartTime = Date.now();
            gameState.playCount++;

            // 檢查徽章
            const newBadges = checkBadges();
            if (newBadges.length > 0) {
                newBadges.forEach(badgeId => {
                    const badge = badgesData[badgeId];
                    alert(`🏆 獲得徽章：${badge.name} - ${badge.description}`);
                });
            }

            updateStatsPanel();
            saveGameData();
            displayScene('start');
        }

        // 版本檢查和快取管理
        function checkVersion() {
            const currentVersion = document.querySelector('meta[name="version"]')?.content;
            const lastVersion = localStorage.getItem('gameVersion');
            
            if (currentVersion && lastVersion && currentVersion !== lastVersion) {
                // 版本已更新，清除快取
                console.log('🔄 偵測到新版本，清除本地快取...');
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        for(let registration of registrations) {
                            registration.unregister();
                        }
                    });
                }
                
                // 清除快取儲存
                if ('caches' in window) {
                    caches.keys().then(function(cacheNames) {
                        return Promise.all(
                            cacheNames.map(function(cacheName) {
                                return caches.delete(cacheName);
                            })
                        );
                    });
                }
                
                showSuccessNotification('🎉 遊戲已更新到最新版本！');
            }
            
            if (currentVersion) {
                localStorage.setItem('gameVersion', currentVersion);
            }
        }

        // 強制重新載入功能（開發者用）
        function forceReload() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                    location.reload(true);
                });
            } else {
                location.reload(true);
            }
        }

        // 檢查網路連線和版本更新
        function checkForUpdates() {
            if (navigator.onLine) {
                // 隨機參數避免快取
                const timestamp = new Date().getTime();
                fetch(`./version.json?v=${timestamp}`, { 
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const currentVersion = document.querySelector('meta[name="version"]')?.content;
                    if (data.version && currentVersion && data.version !== currentVersion) {
                        if (confirm('發現新版本！是否要重新載入遊戲？')) {
                            forceReload();
                        }
                    }
                })
                .catch(error => {
                    console.log('版本檢查失敗:', error);
                });
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
            updateAchievementsPanel();
            updateStatsPanel();
            checkVersion();
            console.log('🎃 Tsext Adventure: Halloween Haunt 已載入！');
            
            // 每 5 分鐘檢查一次更新
            setInterval(checkForUpdates, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
