name: GitHub Pages å¿«å–ç®¡ç†

on:
  workflow_dispatch:
    inputs:
      cache_action:
        description: 'å¿«å–ç®¡ç†å‹•ä½œ'
        required: true
        default: 'purge'
        type: choice
        options:
        - purge
        - version-check
        - full-redeploy
  push:
    branches: [ main ]
    paths:
    - 'web/**'
    - 'scripts/**'
    - 'version.json'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  cache-management:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    
    - name: åŸ·è¡Œç‰ˆæœ¬ç®¡ç†
      run: |
        echo "ğŸ”§ åŸ·è¡Œç‰ˆæœ¬ç®¡ç†å’Œå¿«å–æ¸…é™¤..."
        
        # åŸ·è¡Œç‰ˆæœ¬ç®¡ç†è…³æœ¬
        if [ -f "scripts/version-manager.py" ]; then
          python3 scripts/version-manager.py
        else
          echo "âš ï¸  ç‰ˆæœ¬ç®¡ç†è…³æœ¬ä¸å­˜åœ¨ï¼Œå»ºç«‹åŸºæœ¬ç‰ˆæœ¬è³‡è¨Š"
          mkdir -p scripts
          cat > scripts/version-manager.py << 'EOF'
        #!/usr/bin/env python3
        import json
        import datetime
        
        version_data = {
            "version": "1.0.0",
            "build_number": 1,
            "last_updated": datetime.datetime.now().isoformat(),
            "files": {}
        }
        
        with open("version.json", "w") as f:
            json.dump(version_data, f, indent=2)
        EOF
          python3 scripts/version-manager.py
        fi
    
    - name: å»ºç«‹å¿«å–æ¸…é™¤æª”æ¡ˆ
      run: |
        echo "ğŸ§¹ å»ºç«‹å¿«å–æ¸…é™¤æª”æ¡ˆ..."
        
        # å»ºç«‹å¿«å–æ¸…é™¤æŒ‡å—
        cat > deploy/cache-info.md << 'EOF'
        # GitHub Pages å¿«å–æ¸…é™¤æŒ‡å—
        
        ## ğŸš€ éƒ¨ç½²è³‡è¨Š
        - **éƒ¨ç½²æ™‚é–“**: $(date +"%Y-%m-%d %H:%M:%S UTC")
        - **GitHub Actions**: è‡ªå‹•åŒ–éƒ¨ç½²
        - **å¿«å–ç®¡ç†**: å·²å•Ÿç”¨
        
        ## ğŸ§¹ å³æ™‚è§£æ±ºæ–¹æ³•
        
        ### 1. å¼·åˆ¶é‡æ–°æ•´ç†
        - **Windows/Linux**: `Ctrl + F5` æˆ– `Ctrl + Shift + R`
        - **Mac**: `Cmd + Shift + R`
        - **æ‰‹æ©Ÿ**: é•·æŒ‰é‡æ–°æ•´ç†æŒ‰éˆ•é¸æ“‡ã€Œé‡æ–°è¼‰å…¥ã€
        
        ### 2. ç„¡ç—•æ¨¡å¼
        é–‹å•Ÿç€è¦½å™¨çš„ç„¡ç—•/éš±ç§æ¨¡å¼ç€è¦½ç¶²ç«™
        
        ### 3. æ¸…é™¤ç€è¦½å™¨å¿«å–
        æ‰‹å‹•æ¸…é™¤ç€è¦½å™¨çš„å¿«å–è³‡æ–™
        
        ## â° ç­‰å¾… CDN æ›´æ–°
        GitHub Pages CDN é€šå¸¸éœ€è¦ 5-10 åˆ†é˜æ›´æ–°
        
        ## ğŸ” ç‰ˆæœ¬æª¢æŸ¥
        è¨ªå• `/version-check.html` æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬
        
        ---
        *è‡ªå‹•ç”Ÿæˆæ–¼ GitHub Actions*
        EOF
        
        # å»ºç«‹ç‰ˆæœ¬æª¢æŸ¥é é¢
        cat > deploy/version-check.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
            <meta http-equiv="Pragma" content="no-cache" />
            <meta http-equiv="Expires" content="0" />
            <title>ç‰ˆæœ¬æª¢æŸ¥ - Tsext Adventure</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
                    color: #fff; 
                    min-height: 100vh;
                    margin: 0;
                }
                .container { 
                    max-width: 600px; 
                    margin: 0 auto; 
                    background: rgba(0, 0, 0, 0.8);
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
                }
                .version-info { 
                    background: #333; 
                    padding: 20px; 
                    border-radius: 10px; 
                    margin: 20px 0; 
                    border: 2px solid #ff6b35;
                }
                .timestamp { 
                    color: #ff6b35; 
                    font-weight: bold; 
                }
                .instructions { 
                    background: #2a2a4e; 
                    padding: 15px; 
                    border-radius: 5px; 
                    margin: 20px 0;
                }
                .btn {
                    display: inline-block;
                    padding: 10px 20px;
                    background: #ff6b35;
                    color: white;
                    text-decoration: none;
                    border-radius: 5px;
                    margin: 10px 5px;
                }
                .btn:hover {
                    background: #e55a2b;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸƒ Tsext Adventure - ç‰ˆæœ¬æª¢æŸ¥</h1>
                
                <div class="version-info">
                    <h2>ğŸ“Š ç•¶å‰ç‰ˆæœ¬è³‡è¨Š</h2>
                    <p><strong>é é¢è¼‰å…¥æ™‚é–“:</strong> <span class="timestamp" id="loadTime"></span></p>
                    <p><strong>GitHub Actions:</strong> <span class="timestamp" id="buildInfo">æª¢æŸ¥ä¸­...</span></p>
                    <p><strong>ç€è¦½å™¨å¿«å–:</strong> <span id="cacheStatus">æª¢æŸ¥ä¸­...</span></p>
                </div>
                
                <div class="instructions">
                    <h3>ğŸ§¹ å¦‚æœçœ‹åˆ°èˆŠç‰ˆæœ¬ï¼Œè«‹å˜—è©¦ï¼š</h3>
                    <ul>
                        <li>æŒ‰ <strong>Ctrl+F5</strong> (Windows/Linux) æˆ– <strong>Cmd+Shift+R</strong> (Mac) å¼·åˆ¶é‡æ–°æ•´ç†</li>
                        <li>é–‹å•Ÿç„¡ç—•æ¨¡å¼ç€è¦½</li>
                        <li>æ¸…é™¤ç€è¦½å™¨å¿«å–</li>
                        <li>ç­‰å¾… 5-10 åˆ†é˜è®“ CDN æ›´æ–°</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <a href="index.html" class="btn">ğŸ® å›åˆ°éŠæˆ²</a>
                    <a href="cache-info.md" class="btn">ğŸ“‹ å¿«å–æŒ‡å—</a>
                </div>
            </div>
            
            <script>
                document.getElementById('loadTime').textContent = new Date().toISOString();
                
                // æª¢æŸ¥å¿«å–ç‹€æ…‹
                if ('caches' in window) {
                    caches.keys().then(function(cacheNames) {
                        const cacheCount = cacheNames.length;
                        document.getElementById('cacheStatus').textContent = 
                            cacheCount > 0 ? `æ‰¾åˆ° ${cacheCount} å€‹å¿«å–` : 'ç„¡å¿«å–';
                    });
                } else {
                    document.getElementById('cacheStatus').textContent = 'ç€è¦½å™¨ä¸æ”¯æ´å¿«å– API';
                }
                
                // è¼‰å…¥ç‰ˆæœ¬è³‡è¨Š
                fetch('version.json')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('buildInfo').textContent = 
                            `ç‰ˆæœ¬ ${data.version} (å»ºç½® #${data.build_number})`;
                    })
                    .catch(error => {
                        document.getElementById('buildInfo').textContent = 'ç„¡æ³•è¼‰å…¥ç‰ˆæœ¬è³‡è¨Š';
                    });
                
                // è¨˜éŒ„é é¢è¼‰å…¥
                console.log('ç‰ˆæœ¬æª¢æŸ¥é é¢è¼‰å…¥:', new Date().toISOString());
            </script>
        </body>
        </html>
        EOF
        
        echo "âœ… å¿«å–æ¸…é™¤æª”æ¡ˆå»ºç«‹å®Œæˆ"
    
    - name: éƒ¨ç½²åˆ° GitHub Pages (å«å¿«å–ç®¡ç†)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ° GitHub Pages..."
        
        # è¨­å®š Pages
        echo "GITHUB_TOKEN" | gh auth login --with-token
        
        # è¤‡è£½æª”æ¡ˆåˆ°éƒ¨ç½²ç›®éŒ„
        mkdir -p deploy/github-pages
        cp web/index.html deploy/github-pages/
        cp web/DEPLOYMENT.md deploy/github-pages/ 2>/dev/null || echo "DEPLOYMENT.md ä¸å­˜åœ¨"
        cp deploy/cache-info.md deploy/github-pages/
        cp deploy/version-check.html deploy/github-pages/
        cp version.json deploy/github-pages/
        
        # å»ºç«‹ .nojekyll æª”æ¡ˆ
        touch deploy/github-pages/.nojekyll
        
        # åˆ‡æ›åˆ°éƒ¨ç½²ç›®éŒ„
        cd deploy/github-pages
        
        # åˆå§‹åŒ– git ä¸¦æ¨é€åˆ° gh-pages åˆ†æ”¯
        git init
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "ğŸš€ è‡ªå‹•éƒ¨ç½² (å«å¿«å–ç®¡ç†) - $(date)"
        
        # æ¨é€åˆ° gh-pages åˆ†æ”¯
        git branch -M gh-pages
        git remote add origin https://github.com/${{ github.repository }}.git
        git push -f origin gh-pages
        
        echo "âœ… éƒ¨ç½²å®Œæˆ"
    
    - name: æ¸…é™¤ CDN å¿«å–
      run: |
        echo "ğŸ§¹ åŸ·è¡Œ CDN å¿«å–æ¸…é™¤..."
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        sleep 30
        
        # è§¸ç™¼é é¢è¼‰å…¥ä»¥æ›´æ–°å¿«å–
        REPO_NAME="${{ github.repository }}"
        PAGES_URL="https://${REPO_NAME#*/}.github.io/${REPO_NAME##*/}"
        
        echo "æ¸¬è©¦é é¢è¼‰å…¥: $PAGES_URL"
        curl -I "$PAGES_URL" || echo "ç„¡æ³•è¨ªå•ä¸»é é¢"
        curl -I "$PAGES_URL/version-check.html" || echo "ç„¡æ³•è¨ªå•ç‰ˆæœ¬æª¢æŸ¥é é¢"
        
        # ä½¿ç”¨ GitHub API æ¸…é™¤å¿«å– (å¦‚æœå¯ç”¨)
        echo "å˜—è©¦æ¸…é™¤ GitHub Pages å¿«å–..."
        gh api -X POST /repos/${{ github.repository }}/actions/caches/delete || echo "ç„¡æ³•æ¸…é™¤ GitHub Actions å¿«å–"
        
        echo "âœ… CDN å¿«å–æ¸…é™¤å®Œæˆ"
    
    - name: éƒ¨ç½²ç‹€æ…‹é€šçŸ¥
      run: |
        echo "ğŸ“Š éƒ¨ç½²ç‹€æ…‹æ‘˜è¦:"
        echo "- ç‰ˆæœ¬: $(cat version.json | grep version | cut -d'"' -f4)"
        echo "- å»ºç½®ç·¨è™Ÿ: $(cat version.json | grep build_number | cut -d':' -f2 | tr -d ' ,')"
        echo "- éƒ¨ç½²æ™‚é–“: $(date)"
        echo "- GitHub Pages URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "- ç‰ˆæœ¬æª¢æŸ¥: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/version-check.html"
