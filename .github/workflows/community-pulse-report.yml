name: Community Pulse Report

# é€™æ˜¯ä¸€å€‹ä½¿ç”¨ Community Pulse Reporter Action çš„ç¯„ä¾‹å·¥ä½œæµ
# å¯ä»¥è‡ªå‹•ç”Ÿæˆç¤¾ç¾¤è²¢ç»å ±å‘Šä¸¦æäº¤åˆ°å€‰åº«

on:
  # å®šæœŸåŸ·è¡Œ - æ¯æœˆ 1 è™Ÿç”Ÿæˆæœˆåº¦å ±å‘Š
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ 1 è™Ÿ 00:00 UTC
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      interval:
        description: 'åˆ†ææ™‚é–“ç¯„åœï¼ˆå¤©æ•¸ï¼‰'
        required: false
        default: '30'
      
      output_file:
        description: 'è¼¸å‡ºæ–‡ä»¶å'
        required: false
        default: 'COMMUNITY_REPORT.md'

jobs:
  generate-report:
    name: ç”Ÿæˆç¤¾ç¾¤è²¢ç»å ±å‘Š
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†æäº¤å ±å‘Š
    
    steps:
      # 1. æª¢å‡ºå€‰åº«
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥ä¾¿åˆ†æ
      
      # 2. ç”Ÿæˆç¤¾ç¾¤å ±å‘Š
      - name: ğŸ“Š Generate Community Pulse Report
        id: report
        uses: ./  # ä½¿ç”¨æœ¬åœ° Actionï¼ˆç™¼å¸ƒå¾Œæ”¹ç‚º dennislee928/Sext-Adventure@mainï¼‰
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo_owner: ${{ github.repository_owner }}
          repo_name: ${{ github.event.repository.name }}
          interval: ${{ github.event.inputs.interval || '30' }}
          output_file: ${{ github.event.inputs.output_file || 'COMMUNITY_REPORT.md' }}
          include_stats: 'true'
      
      # 3. é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
      - name: ğŸ“ˆ Display Statistics
        run: |
          echo "## ğŸ“Š å ±å‘Šçµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ‘¥ æ´»èºè²¢ç»è€…: ${{ steps.report.outputs.total_contributors }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”€ ç¸½ PRs: ${{ steps.report.outputs.total_prs }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ ç¸½ Issues: ${{ steps.report.outputs.total_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“„ å ±å‘Šæ–‡ä»¶: ${{ steps.report.outputs.report_file }}" >> $GITHUB_STEP_SUMMARY
      
      # 4. æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
      - name: ğŸ” Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi
      
      # 5. æäº¤å ±å‘Šï¼ˆå¦‚æœæœ‰è®Šæ›´ï¼‰
      - name: ğŸ’¾ Commit report
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ${{ steps.report.outputs.report_file }}
          git commit -m "ğŸ“Š æ›´æ–°ç¤¾ç¾¤è²¢ç»å ±å‘Š | Update Community Pulse Report
          
          - æ´»èºè²¢ç»è€…: ${{ steps.report.outputs.total_contributors }} äºº
          - Total PRs: ${{ steps.report.outputs.total_prs }}
          - Total Issues: ${{ steps.report.outputs.total_issues }}
          
          Generated by Community Pulse Reporter
          " || exit 0
          git push
      
      # 6. æˆåŠŸé€šçŸ¥
      - name: âœ… Success notification
        if: success()
        run: |
          echo "âœ… ç¤¾ç¾¤è²¢ç»å ±å‘Šå·²æˆåŠŸç”Ÿæˆä¸¦æäº¤ï¼"
          echo ""
          echo "ğŸ“Š çµ±è¨ˆæ‘˜è¦ï¼š"
          echo "  - æ´»èºè²¢ç»è€…: ${{ steps.report.outputs.total_contributors }}"
          echo "  - ç¸½ PRs: ${{ steps.report.outputs.total_prs }}"
          echo "  - ç¸½ Issues: ${{ steps.report.outputs.total_issues }}"
      
      # 7. å¤±æ•—é€šçŸ¥
      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ ç”Ÿæˆå ±å‘Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ"

